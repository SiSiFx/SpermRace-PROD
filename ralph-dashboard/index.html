<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ralph</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #050508;
      color: #e6edf3;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 12px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      padding: 12px 20px;
      background: rgba(5, 5, 8, 0.95);
      border-bottom: 1px solid rgba(0, 245, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0, 245, 255, 0.1);
      z-index: 10;
    }
    header h1 { font-size: 16px; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
    header h1 span { color: #00f5ff; text-shadow: 0 0 10px rgba(0, 245, 255, 0.5); }
    .status { display: flex; align-items: center; gap: 12px; font-size: 11px; color: rgba(255, 255, 255, 0.6); }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #39ff14; box-shadow: 0 0 8px #39ff14; transition: all 0.3s ease; }
    .dot.off { background: #ff003c; box-shadow: 0 0 8px #ff003c; }
    .agents-count { background: rgba(0, 245, 255, 0.1);
      border: 1px solid rgba(0, 245, 255, 0.3); padding: 4px 10px; border-radius: 4px; color: #00f5ff; font-weight: 600; font-size: 10px; letter-spacing: 0.05em; }

    .container {
      flex: 1;
      display: flex;
      overflow: hidden;
      background-image: 
        linear-gradient(rgba(0, 245, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 245, 255, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    .sidebar {
      width: 380px;
      border-right: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(10, 10, 15, 0.6);
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(5px);
    }

    .sidebar-header {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      font-weight: 700;
      color: #bf00ff;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sidebar-header::before { content: ''; width: 6px; height: 6px; background: #bf00ff; border-radius: 50%; box-shadow: 0 0 6px #bf00ff; }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      line-height: 1.5;
      color: #a0a0a0;
    }
    
    /* Log Styling */
    .log { margin-bottom: 4px; animation: fadeIn 0.2s ease-out; }
    .log-time { color: #555; margin-right: 8px; user-select: none; }
    .log-info { color: #00f5ff; }
    .log-warn { color: #ffeb3b; }
    .log-error { color: #ff003c; }

    .agents {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      grid-auto-rows: minmax(200px, auto);
      gap: 16px;
      padding: 20px;
      overflow-y: auto;
      align-content: start;
    }

    .agent {
      background: rgba(15, 15, 20, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.2s ease;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .agent:hover {
      border-color: rgba(0, 245, 255, 0.4);
      box-shadow: 0 0 15px rgba(0, 245, 255, 0.1);
      transform: translateY(-2px);
    }

    .agent-header {
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .agent-name {
      font-weight: 700;
      color: #00f5ff;
      font-size: 12px;
      letter-spacing: 0.05em;
    }

    .agent-status {
      font-size: 9px;
      padding: 3px 8px;
      border-radius: 10px;
      background: rgba(57, 255, 20, 0.1);
      border: 1px solid rgba(57, 255, 20, 0.3);
      color: #39ff14;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .agent-status.idle { background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); color: #888; }

    .agent-files {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 10px;
      color: #666;
      max-height: 80px;
      overflow-y: auto;
    }

    .agent-files .file {
      padding: 2px 0;
      color: #a0a0a0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .agent-files .file::before { content: 'â€¢'; color: #444; }

    .agent-files .file.modified { color: #facc15; }
    .agent-files .file.modified::before { color: #facc15; }

    .agent-logs {
      flex: 1;
      overflow-y: auto;
      padding: 10px 14px;
      font-size: 10px;
      font-family: 'JetBrains Mono', monospace;
      background: rgba(0, 0, 0, 0.2);
    }

    .agent-log {
      padding: 3px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      display: flex;
      gap: 8px;
    }

    .agent-log .time { color: #444; min-width: 45px; }
    .agent-log .tool { color: #bf00ff; }
    .agent-log .result { color: #39ff14; }
    .agent-log .error { color: #ff003c; }
    .agent-log .text { color: #ccc; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ¤– <span>Ralph</span> Monitor</h1>
    <div class="status">
      <div class="dot" id="dot"></div>
      <span id="status">connecting...</span>
      <span class="agents-count" id="agentCount">0 agents</span>
    </div>
  </header>

  <div class="container">
    <div class="sidebar">
      <div class="sidebar-header">ðŸ§  Orchestrator</div>
      <div class="sidebar-content" id="orchestratorLogs"></div>
    </div>
    <div class="agents" id="agents"></div>
  </div>

  <script>
    const agentsEl = document.getElementById('agents');
    const orchEl = document.getElementById('orchestratorLogs');
    const dot = document.getElementById('dot');
    const status = document.getElementById('status');
    const agentCountEl = document.getElementById('agentCount');

    const agents = {};

    function addOrchLog(text) {
      const div = document.createElement('div');
      div.className = 'log';
      div.textContent = text;
      orchEl.appendChild(div);
      orchEl.scrollTop = orchEl.scrollHeight;
      
      // Limit lines
      while (orchEl.children.length > 500) {
        orchEl.removeChild(orchEl.firstChild);
      }
    }

    function getAgent(id) {
      if (!agents[id]) {
        agents[id] = { logs: [], files: [], status: 'active' };
        renderAgents();
      }
      return agents[id];
    }

    function addLog(agentId, level, text) {
      const agent = getAgent(agentId);
      const time = new Date().toLocaleTimeString('en-GB', { hour12: false });
      agent.logs.push({ time, level, text });
      if (agent.logs.length > 50) agent.logs.shift();
      renderAgents();
    }

    function setFiles(agentId, files) {
      const agent = getAgent(agentId);
      agent.files = files;
      renderAgents();
    }

    function renderAgents() {
      const ids = Object.keys(agents).sort((a, b) => parseInt(a) - parseInt(b));

      agentsEl.innerHTML = ids.map(id => {
        const a = agents[id];
        const filesHtml = a.files.map(f => {
          const cls = f.startsWith('M ') ? 'modified' : '';
          return `<div class="file ${cls}">${f}</div>`;
        }).join('');

        const logsHtml = a.logs.slice(-30).map(l =>
          `<div class="log"><span class="time">${l.time}</span><span class="${l.level}">${l.text}</span></div>`
        ).join('');

        return `
          <div class="agent">
            <div class="agent-header">
              <span class="agent-name">Agent ${id}</span>
              <span class="agent-status ${a.status}">${a.status}</span>
            </div>
            <div class="agent-files">${filesHtml || '<em>No changes yet</em>'}</div>
            <div class="agent-logs">${logsHtml || '<em>Waiting...</em>'}</div>
          </div>
        `;
      }).join('');

      agentCountEl.textContent = `${ids.length} agents`;
    }

    function connect() {
      const ws = new WebSocket(`ws://${location.host}`);
      ws.onopen = () => { dot.classList.remove('off'); status.textContent = 'live'; };
      ws.onclose = () => { dot.classList.add('off'); status.textContent = 'reconnecting...'; setTimeout(connect, 2000); };
      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);

        if (msg.type === 'orchestrator_log') {
          addOrchLog(msg.text);
        } else if (msg.type === 'agent_log') {
          addLog(msg.agent, msg.level, msg.text);
        } else if (msg.type === 'agent_files') {
          setFiles(msg.agent, msg.files);
        } else if (msg.type === 'agent_status') {
          getAgent(msg.agent).status = msg.status;
          renderAgents();
        } else if (msg.type === 'log') {
          // Global log - try to extract agent
          const match = msg.text.match(/Agent (\d+)/);
          if (match) {
            addLog(match[1], msg.level, msg.text);
          }
        }
      };
    }
    connect();
  </script>
</body>
</html>
