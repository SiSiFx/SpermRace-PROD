import { useEffect, useState } from 'react';
import { useWallet } from '../WalletProvider';
import { useWs } from '../WsProvider';

// Base URL for backend API.
// For any spermrace.io host (prod/dev/www), always use same-origin /api so hosting can proxy
// and we avoid CORS when VITE_API_BASE points at api.spermrace.io.
const API_BASE: string = (() => {
  try {
    const host = (window?.location?.hostname || '').toLowerCase();
    if (host.endsWith('spermrace.io')) return '/api';
  } catch {}

  const env = (import.meta as any).env?.VITE_API_BASE as string | undefined;
  if (env && typeof env === 'string' && env.trim()) return env.trim();

  try {
    const host = (window?.location?.hostname || '').toLowerCase();
    if (host.includes('dev.spermrace.io')) return 'https://dev.spermrace.io/api';
    if (host.includes('spermrace.io')) return 'https://spermrace.io/api';
  } catch {}
  return '/api';
})();

type Tier = {
  id: 'micro' | 'nano' | 'mega' | 'championship';
  name: string;
  usd: number;
  maxPlayers: number;
  duration: string;
};

type PrizePreflight = {
  address: string | null;
  sol: number | null;
  configured: boolean;
} | null;

const TIERS: Tier[] = [
  { id: 'micro', name: 'Micro Race', usd: 1, maxPlayers: 16, duration: '2–3 min' },
  { id: 'nano', name: 'Nano Race', usd: 5, maxPlayers: 32, duration: '3–4 min' },
  { id: 'mega', name: 'Mega Race', usd: 25, maxPlayers: 32, duration: '4–6 min' },
  { id: 'championship', name: 'Championship', usd: 100, maxPlayers: 16, duration: '5–8 min' },
];

// Tier-specific styling - Updated to match design system
const getTierTheme = (tierId: string) => {
  switch (tierId) {
    case 'micro':
      return {
        accent: '#39ff14', // Toxic Green - biological success
        glow: 'rgba(57, 255, 20, 0.5)',
        border: 'rgba(57, 255, 20, 0.8)',
        gradient: 'linear-gradient(135deg, rgba(57, 255, 20, 0.15) 0%, rgba(57, 255, 20, 0.05) 100%)',
      };
    case 'nano':
      return {
        accent: '#00ffff', // Electric Cyan - tech energy (recommended)
        glow: 'rgba(0, 255, 255, 0.5)',
        border: 'rgba(0, 255, 255, 0.8)',
        gradient: 'linear-gradient(135deg, rgba(0, 255, 255, 0.15) 0%, rgba(0, 255, 255, 0.05) 100%)',
      };
    case 'mega':
      return {
        accent: '#ffd700', // Winner Gold - premium tier
        glow: 'rgba(255, 215, 0, 0.5)',
        border: 'rgba(255, 215, 0, 0.8)',
        gradient: 'linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.05) 100%)',
      };
    case 'championship':
      return {
        accent: '#bf00ff', // Plasma Purple - high roller exclusive
        glow: 'rgba(191, 0, 255, 0.5)',
        border: 'rgba(191, 0, 255, 0.8)',
        gradient: 'linear-gradient(135deg, rgba(191, 0, 255, 0.15) 0%, rgba(255, 215, 0, 0.1) 50%, rgba(0, 255, 255, 0.05) 100%)',
      };
    default:
      return {
        accent: '#39ff14',
        glow: 'rgba(57, 255, 20, 0.5)',
        border: 'rgba(57, 255, 20, 0.8)',
        gradient: 'linear-gradient(135deg, rgba(57, 255, 20, 0.15) 0%, rgba(57, 255, 20, 0.05) 100%)',
      };
  }
};

type ExposedJoinApi = {
  joinTier: (usd: number) => void;
  busy: boolean;
  disabled: boolean;
};

type ModesProps = {
  exposeJoin?: (api: ExposedJoinApi) => void;
};

function Modes({ exposeJoin }: ModesProps = {}) {
  const { publicKey, connect } = useWallet() as any;
  const { connectAndJoin, state: wsState } = useWs() as any;
  const [isJoining, setIsJoining] = useState(false);
  const [preflight, setPreflight] = useState<PrizePreflight>(null);
  const [preflightError, setPreflightError] = useState(false);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        const r = await fetch(`${API_BASE}/prize-preflight`);
        if (!r.ok) throw new Error(`preflight ${r.status}`);
        const j = await r.json();
        if (cancelled) return;
        setPreflight(j);
        const misconfigured = !j?.configured || !j?.address || j?.sol == null;
        setPreflightError(!!misconfigured);
      } catch {
        if (!cancelled) setPreflightError(true);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, []);

  useEffect(() => {
    if (wsState.phase === 'lobby' || wsState.phase === 'game') setIsJoining(false);
  }, [wsState.phase]);

  const globalDisabled =
    preflightError ||
    !!(
      preflight &&
      (!preflight.configured || !preflight.address || preflight.sol == null)
    );

  const busy =
    isJoining || wsState.phase === 'connecting' || wsState.phase === 'authenticating';

  useEffect(() => {
    if (!exposeJoin) return;
    exposeJoin({
      joinTier: (usd: number) => {
        void handleJoin(usd);
      },
      busy,
      disabled: globalDisabled,
    });
  }, [exposeJoin, busy, globalDisabled]);

  const handleJoin = async (tierUsd: number) => {
    if (globalDisabled) return;
    setIsJoining(true);
    try {
      const ok = publicKey ? true : await connect();
      if (!ok) {
        setIsJoining(false);
        return;
      }
      await connectAndJoin({ entryFeeTier: tierUsd as any, mode: 'tournament' });
    } catch {
      setIsJoining(false);
    }
  };

  return (
    <div
      className="mode-grid"
      style={{
        maxWidth: 960,
        margin: '32px auto 24px',
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fit, minmax(260px, 1fr))',
        gap: 20,
      }}
    >
      {TIERS.map((tier) => {
        const estPrizeUsd = (tier.usd * tier.maxPlayers * 0.85).toFixed(2);
        const disabled = busy || globalDisabled;
        const theme = getTierTheme(tier.id);

        return (
          <button
            key={tier.id}
            type="button"
            disabled={disabled}
            className="tech-tournament-card"
            style={{
              position: 'relative',
              background: `linear-gradient(135deg, rgba(5,5,8,0.95) 0%, rgba(10,10,15,0.9) 100%)`,
              borderRadius: 20,
              border: `2px solid ${theme.border}`,
              padding: '24px',
              cursor: disabled ? 'not-allowed' : 'pointer',
              textAlign: 'left',
              boxShadow: disabled
                ? 'none'
                : `0 8px 32px rgba(0,0,0,0.6), 0 0 0 1px ${theme.glow}`,
              transition: 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
              opacity: disabled ? 0.5 : 1,
              overflow: 'hidden',
              backdropFilter: 'blur(20px)',
              WebkitBackdropFilter: 'blur(20px)',
              fontFamily: '"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, monospace',
            }}
            onClick={() => handleJoin(tier.usd)}
            onMouseEnter={(e) => {
              if (disabled) return;
              e.currentTarget.style.borderColor = theme.accent;
              e.currentTarget.style.boxShadow =
                `0 20px 60px rgba(0,0,0,0.8), 0 0 40px ${theme.glow}, inset 0 0 20px ${theme.glow}`;
              e.currentTarget.style.background = theme.gradient;
              e.currentTarget.style.transform = 'translateY(-10px) scale(1.03) rotateX(2deg)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.borderColor = theme.border;
              e.currentTarget.style.boxShadow = disabled
                ? 'none'
                : `0 8px 32px rgba(0,0,0,0.6), 0 0 0 1px ${theme.glow}`;
              e.currentTarget.style.background = `linear-gradient(135deg, rgba(5,5,8,0.95) 0%, rgba(10,10,15,0.9) 100%)`;
              e.currentTarget.style.transform = 'translateY(0) scale(1) rotateX(0)';
            }}
          >
            {/* Tech grid pattern overlay */}
            <div
              style={{
                position: 'absolute',
                top: 0,
                left: 0,
                width: '100%',
                height: '100%',
                backgroundImage: `
                  linear-gradient(${theme.glow} 1px, transparent 1px),
                  linear-gradient(90deg, ${theme.glow} 1px, transparent 1px)
                `,
                backgroundSize: '20px 20px',
                opacity: 0.1,
                pointerEvents: 'none',
                transition: 'opacity 0.4s ease',
              }}
              className="tech-grid-pattern"
            />

            {/* Tier-specific glowing accent bar at top */}
            <div
              style={{
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                height: 3,
                background: `linear-gradient(90deg, ${theme.accent}, ${theme.accent === '#ffd700' ? '#bf00ff' : theme.accent === '#bf00ff' ? '#00ffff' : '#39ff14'}, ${theme.accent})`,
                backgroundSize: '200% 100%',
                animation: 'shimmer-flow 3s ease-in-out infinite',
                boxShadow: `0 0 20px ${theme.glow}`,
              }}
            />

            <div
              style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'flex-start',
                marginBottom: 16,
                position: 'relative',
                zIndex: 1,
              }}
            >
              <div style={{ flex: 1 }}>
                <div
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: 10,
                    marginBottom: 8,
                  }}
                >
                  <div
                    style={{
                      fontSize: 11,
                      letterSpacing: 3,
                      textTransform: 'uppercase',
                      color: theme.accent,
                      fontFamily: '"Orbitron", system-ui, -apple-system, BlinkMacSystemFont, sans-serif',
                      fontWeight: 700,
                      textShadow: `0 0 10px ${theme.glow}`,
                    }}
                  >
                    {tier.name}
                  </div>
                  {tier.id === 'nano' && (
                    <div
                      style={{
                        padding: '3px 10px',
                        background: `linear-gradient(135deg, ${theme.accent}, ${theme.accent}99)`,
                        color: '#050508',
                        fontSize: 9,
                        fontWeight: 900,
                        borderRadius: 6,
                        letterSpacing: 1.5,
                        textTransform: 'uppercase',
                        boxShadow: `0 0 15px ${theme.glow}`,
                        animation: 'pulse-badge 2s ease-in-out infinite',
                      }}
                    >
                      Recommended
                    </div>
                  )}
                </div>
                <div
                  style={{
                    fontSize: 17,
                    fontWeight: 700,
                    color: '#f0f0f5',
                    letterSpacing: 0.5,
                    fontFamily: '"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, monospace',
                  }}
                >
                  <span style={{ color: theme.accent }}>${tier.usd.toFixed(2)}</span> USD entry • {tier.maxPlayers} players
                </div>
              </div>
            </div>

            {/* Enhanced data panel with tech styling */}
            <div
              style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginTop: 16,
                padding: '14px 16px',
                background: `rgba(0,0,0,0.4)`,
                borderRadius: 12,
                border: `1px solid ${theme.glow}`,
                backdropFilter: 'blur(10px)',
                position: 'relative',
                overflow: 'hidden',
              }}
            >
              {/* Animated data stream background */}
              <div
                style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: `linear-gradient(90deg, ${theme.glow} 0%, transparent 50%, ${theme.glow} 100%)`,
                  opacity: 0.05,
                  animation: 'data-stream 2s linear infinite',
                }}
              />

              <div style={{ position: 'relative', zIndex: 1 }}>
                <div style={{
                  fontSize: 9,
                  letterSpacing: 2,
                  textTransform: 'uppercase',
                  color: '#8a8a95',
                  marginBottom: 4,
                  fontFamily: '"JetBrains Mono", ui-monospace, monospace',
                }}>
                  Est. Prize Pool
                </div>
                <div style={{
                  color: theme.accent,
                  fontSize: 20,
                  fontWeight: 800,
                  letterSpacing: 1,
                  textShadow: `0 0 20px ${theme.glow}`,
                  fontFamily: '"JetBrains Mono", ui-monospace, monospace',
                  animation: 'number-glow 2s ease-in-out infinite',
                }}>
                  ${estPrizeUsd}
                </div>
                <div style={{
                  fontSize: 8,
                  color: '#4a4a55',
                  marginTop: 2,
                  letterSpacing: 1,
                }}>
                  85% WINNER DISTRIBUTION
                </div>
              </div>

              <div style={{ textAlign: 'right', position: 'relative', zIndex: 1 }}>
                <div style={{
                  fontSize: 9,
                  letterSpacing: 2,
                  textTransform: 'uppercase',
                  color: '#8a8a95',
                  marginBottom: 4,
                  fontFamily: '"JetBrains Mono", ui-monospace, monospace',
                }}>
                  Round Length
                </div>
                <div style={{
                  color: '#f0f0f5',
                  fontSize: 16,
                  fontWeight: 700,
                  letterSpacing: 0.5,
                  fontFamily: '"JetBrains Mono", ui-monospace, monospace',
                }}>
                  {tier.duration}
                </div>
              </div>
            </div>

            {preflightError && (
              <div
                style={{
                  marginTop: 10,
                  fontSize: 11,
                  color: 'var(--danger)',
                  opacity: 0.9,
                }}
              >
                Tournament service temporarily unavailable.
              </div>
            )}

            {busy && !preflightError && (
              <div
                style={{
                  marginTop: 10,
                  fontSize: 11,
                  color: 'var(--text-secondary)',
                }}
              >
                {wsState.entryFee?.pending
                  ? 'Verifying entry fee on Solana…'
                  : wsState.phase === 'authenticating'
                  ? 'Waiting for wallet signature…'
                  : 'Connecting…'}
              </div>
            )}
          </button>
        );
      })}
    </div>
  );
}

export default Modes;
export { Modes };
